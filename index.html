<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Reliability NPV Tool — Veritas Reliability</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
*,*::before,*::after{box-sizing:border-box}
body{font-family:Arial,system-ui,sans-serif;margin:20px;background:#fff;color:#000}

/* ===== CARDS ===== */
.card{background:#F2F2F2;border:1px solid #e2e2e2;border-radius:14px;padding:22px 24px;margin-bottom:18px}
.inner-card{background:#fff;border:1px solid #e2e2e2;border-radius:12px;padding:16px}

h3{margin:0 0 6px;font-size:1.1rem}
.muted{font-size:13px;color:#555;margin-bottom:12px}
.desc{font-size:12px;color:#666;margin-top:4px}

/* ===== INPUTS ===== */
.row{display:grid;grid-template-columns:1fr 180px;gap:14px;margin:12px 0}
label{font-weight:600}
input[type=number]{width:100%;padding:10px;border-radius:8px;border:1px solid #d0d0d0}

/* ===== BUTTONS ===== */
.actions{display:flex;gap:10px}
button{background:#000;color:#fff;border:1px solid #000;border-radius:10px;padding:10px 18px;font-weight:700;cursor:pointer}

/* ===== KPIs ===== */
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:14px}
@media (max-width: 820px){
  .kpis{grid-template-columns:repeat(2,1fr)}
}
.kpi{background:#fff;border:1px solid #e2e2e2;border-radius:12px;padding:14px}
.kpi .label{font-size:12px;color:#666}
.kpi .value{font-size:18px;font-weight:700}

/* ===== CHART TABS ===== */
.chart-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
.chart-tabs button{background:#fff;color:#000;border:1px solid #000;border-radius:999px;padding:8px 16px;font-weight:700}
.chart-tabs button.active{background:#000;color:#fff}
.chart-wrap{display:none}
.chart-wrap.active{display:block}

/* ===== TABLE ===== */
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #d0d0d0;padding:8px;text-align:right}
th{background:#000;color:#fff}
td.label,th.label{text-align:left}
</style>
</head>

<body>

<!-- ================= GLOBAL SETTINGS ================= -->
<div class="card">
<h3>Global Analysis Settings</h3>
<p class="muted">Financial assumptions applied consistently across the evaluation horizon.</p>

<div class="row">
  <div><label>Analysis Horizon (years)</label><div class="desc">Total period over which costs and benefits are evaluated.</div></div>
  <input id="horizon" type="number" value="10">
</div>

<div class="row">
  <div><label>Discount Rate (% p.a.)</label><div class="desc">Used to discount future cash flows to present value.</div></div>
  <input id="discount" type="number" value="10">
</div>

<div class="row">
  <div><label>Escalation Rate (% p.a.)</label><div class="desc">Annual growth applied to operating costs and benefits.</div></div>
  <input id="escalation" type="number" value="2.5">
</div>

<div class="row">
  <div><label>Salvage Value</label><div class="desc">Residual value realised at the end of the analysis horizon.</div></div>
  <input id="salvage" type="number" value="0">
</div>
</div>

<!-- ================= PROJECT INPUTS ================= -->
<div class="card">
<h3>Project Inputs (Incremental vs Current)</h3>
<p class="muted">Differences between the current and proposed maintenance strategies.</p>

<div class="row"><div><label>CapEx at t = 0</label><div class="desc">Initial capital investment required.</div></div><input id="capex" type="number" value="-250000"></div>
<div class="row"><div><label>Annual PM Cost (Current)</label><div class="desc">Recurring planned maintenance expenditure under the current strategy.</div></div><input id="pmAnnualBefore" type="number" value="120000"></div>
<div class="row"><div><label>Annual PM Cost (After)</label><div class="desc">Recurring planned maintenance expenditure after implementation.</div></div><input id="pmAnnualAfter" type="number" value="140000"></div>
<div class="row"><div><label>Planned PM Cost (Current)</label><div class="desc">Cost of periodic planned maintenance events.</div></div><input id="pmPlannedBefore" type="number" value="300000"></div>
<div class="row"><div><label>Planned PM Frequency (Current, yrs)</label><div class="desc">Interval between planned maintenance events.</div></div><input id="pmFreqBefore" type="number" value="5"></div>
<div class="row"><div><label>Planned PM Cost (After)</label><div class="desc">Planned maintenance cost after change.</div></div><input id="pmPlannedAfter" type="number" value="200000"></div>
<div class="row"><div><label>Planned PM Frequency (After, yrs)</label><div class="desc">Interval between planned maintenance events after change.</div></div><input id="pmFreqAfter" type="number" value="6"></div>
<div class="row"><div><label>Failure Cost (Current)</label><div class="desc">Annual cost of unplanned failures.</div></div><input id="failBefore" type="number" value="400000"></div>
<div class="row"><div><label>Failure Cost (After)</label><div class="desc">Expected failure cost after improvement.</div></div><input id="failAfter" type="number" value="260000"></div>
<div class="row"><div><label>Downtime Cost / Hour</label><div class="desc">Value of lost production per hour of downtime.</div></div><input id="dtCost" type="number" value="5000"></div>
<div class="row"><div><label>Downtime Hours Saved / Year</label><div class="desc">Expected reduction in downtime hours per year.</div></div><input id="dtSaved" type="number" value="30"></div>
<div class="row"><div><label>Other Benefits</label><div class="desc">Additional quantified benefits.</div></div><input id="otherBen" type="number" value="0"></div>
<div class="row"><div><label>Other Costs</label><div class="desc">Additional quantified costs.</div></div><input id="otherCost" type="number" value="0"></div>
</div>

<!-- ================= ACTIONS & KPIs ================= -->
<div class="card">
<div class="actions">
<button id="calc">Calculate</button>
<button id="clear">Clear</button>
</div>

<div class="kpis">
  <div class="kpi"><div class="label">NPV</div><div class="value" id="npv">—</div></div>
  <div class="kpi"><div class="label">Payback (yrs)</div><div class="value" id="pb">—</div></div>
  <div class="kpi"><div class="label">B/C Ratio</div><div class="value" id="bcr">—</div></div>
  <div class="kpi"><div class="label">IRR</div><div class="value" id="irr">—</div></div>
</div>
</div>

<!-- ================= CHARTS ================= -->
<div class="card">
<h3>Charts</h3>
<div class="chart-tabs">
<button class="active" data-t="cf">Cash Flow</button>
<button data-t="cum">Cumulative Cash Flow</button>
<button data-t="cco">Cost of Ownership</button>
<button data-t="disc">NPV Sensitivity</button>
</div>

<div id="cf" class="chart-wrap active"><div class="inner-card"><canvas id="cfChart"></canvas></div></div>
<div id="cum" class="chart-wrap"><div class="inner-card"><canvas id="cumChart"></canvas></div></div>
<div id="cco" class="chart-wrap"><div class="inner-card"><canvas id="ccoChart"></canvas></div></div>
<div id="disc" class="chart-wrap"><div class="inner-card"><canvas id="discChart"></canvas></div></div>
</div>

<!-- ================= RESULTS TABLE ================= -->
<div class="card">
<h3>Results Data Table</h3>
<p class="muted">Year-by-year incremental cash flow and present value results.</p>
<div class="inner-card">
<div id="resultsTable">Click <b>Calculate</b> to generate results.</div>
</div>
</div>

<script>
const $=id=>document.getElementById(id);
let charts={};

function solidLegend(){
  return {
    labels:{
      usePointStyle:true,
      generateLabels(chart){
        const labels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
        labels.forEach(l=>{
          const ds = chart.data.datasets[l.datasetIndex];
          const c = ds.backgroundColor || ds.borderColor;
          l.fillStyle = c;
          l.strokeStyle = c;
          l.lineWidth = 0;
        });
        return labels;
      }
    }
  };
}

function calcPayback(cum){
  for(let i=1;i<cum.length;i++){
    if(cum[i]>=0){
      const prev=cum[i-1];
      const frac=(0-prev)/(cum[i]-prev);
      return (i-1+frac).toFixed(2);
    }
  }
  return "—";
}

function calcIRR(cf){
  const hasPos=cf.some(v=>v>0), hasNeg=cf.some(v=>v<0);
  if(!hasPos||!hasNeg) return null;
  let r=0.1;
  for(let i=0;i<500;i++){
    let f=0,df=0;
    for(let t=0;t<cf.length;t++){
      f+=cf[t]/Math.pow(1+r,t);
      if(t>0) df-=t*cf[t]/Math.pow(1+r,t+1);
    }
    if(Math.abs(f)<1e-6) return r;
    r-=f/df;
  }
  return null;
}

$("calc").onclick=()=>{
  Object.values(charts).forEach(c=>c?.destroy());
  charts={};

  const h=+$("horizon").value,d=+$("discount").value/100,e=+$("escalation").value/100;
  let y=[0],cf=[+$("capex").value],pv=[+$("capex").value],cum=[+$("capex").value],nom=[+$("capex").value];
  let ccoCur=[0],ccoProp=[0];

  for(let i=1;i<=h;i++){
    const esc=Math.pow(1+e,i-1);

    const annualPM=(+$("pmAnnualAfter").value-+$("pmAnnualBefore").value)*esc;
    let planned=0;
    if(i%+$("pmFreqAfter").value===0) planned+=+$("pmPlannedAfter").value;
    if(i%+$("pmFreqBefore").value===0) planned-=+$("pmPlannedBefore").value;
    planned*=esc;

    const fail=(+$("failBefore").value-+$("failAfter").value)*esc;
    const dt=+$("dtCost").value*+$("dtSaved").value*esc;
    const other=(+$("otherBen").value-+$("otherCost").value)*esc;

    let c=fail+dt+other-(annualPM+planned);
    if(i===h) c+=+$("salvage").value;

    y.push(i);cf.push(c);
    pv.push(c/Math.pow(1+d,i));
    cum.push(cum.at(-1)+pv.at(-1));
    nom.push(nom.at(-1)+c);

    const curCost=(+$("pmAnnualBefore").value+(i%+$("pmFreqBefore").value===0?+$("pmPlannedBefore").value:0)+ +$("failBefore").value)*esc;
    const propCost=(+$("pmAnnualAfter").value+(i%+$("pmFreqAfter").value===0?+$("pmPlannedAfter").value:0)+ +$("failAfter").value-+$("dtCost").value*+$("dtSaved").value)*esc;

    ccoCur.push(ccoCur.at(-1)+curCost/Math.pow(1+d,i));
    ccoProp.push(ccoProp.at(-1)+propCost/Math.pow(1+d,i));
  }

  $("npv").textContent="$"+pv.reduce((a,b)=>a+b,0).toFixed(0);
  $("pb").textContent=calcPayback(cum);
  const posPV=pv.filter(v=>v>0).reduce((a,b)=>a+b,0);
  const negPV=pv.filter(v=>v<0).reduce((a,b)=>a+b,0);
  $("bcr").textContent=(negPV===0)?"—":(posPV/Math.abs(negPV)).toFixed(2);
  const irr=calcIRR(cf);
  $("irr").textContent=(irr===null)?"—":(irr*100).toFixed(1)+"%";

  charts.cf=new Chart($("cfChart"),{
    data:{labels:y,datasets:[
      {type:"bar",label:"Cash Flow",data:cf,backgroundColor:"#C2965B"},
      {type:"line",label:"Cumulative PV",data:cum,borderColor:"#000",borderWidth:2}
    ]},
    options:{
      plugins:{legend:solidLegend()},
      scales:{
        x:{title:{display:true,text:"Year"}},
        y:{title:{display:true,text:"Cash Flow / Present Value ($)"}}
      }
    }
  });

  charts.cum=new Chart($("cumChart"),{
    type:"line",
    data:{labels:y,datasets:[
      {label:"Nominal",data:nom,borderColor:"#9CA3AF"},
      {label:"Discounted",data:cum,borderColor:"#000"}
    ]},
    options:{
      plugins:{legend:solidLegend()},
      scales:{
        x:{title:{display:true,text:"Year"}},
        y:{title:{display:true,text:"Cumulative Cash Flow ($)"}}
      }
    }
  });

  charts.cco=new Chart($("ccoChart"),{
    type:"line",
    data:{labels:y,datasets:[
      {label:"Current Strategy",data:ccoCur,borderColor:"#9CA3AF"},
      {label:"Proposed Strategy",data:ccoProp,borderColor:"#000"}
    ]},
    options:{
      plugins:{legend:solidLegend()},
      scales:{
        x:{title:{display:true,text:"Year"}},
        y:{title:{display:true,text:"Cumulative Cost of Ownership ($, PV)"}}
      }
    }
  });

  let r=[],n=[];
  for(let x=0;x<=25;x++){
    r.push(x);
    n.push(cf.reduce((s,v,i)=>s+v/Math.pow(1+x/100,i),0));
  }

  charts.disc=new Chart($("discChart"),{
    type:"line",
    data:{labels:r,datasets:[
      {label:"NPV vs Discount Rate",data:n,borderColor:"#C2965B",borderWidth:2}
    ]},
    options:{
      plugins:{legend:solidLegend()},
      scales:{
        x:{title:{display:true,text:"Discount Rate (%)"}},
        y:{title:{display:true,text:"Net Present Value ($)"}}
      }
    }
  });

  let html="<table><tr><th class='label'>Year</th><th>Cash Flow</th><th>PV</th><th>Cumulative PV</th></tr>";
  for(let i=0;i<y.length;i++){
    html+=`<tr><td class="label">${y[i]}</td><td>$${cf[i].toFixed(0)}</td><td>$${pv[i].toFixed(0)}</td><td>$${cum[i].toFixed(0)}</td></tr>`;
  }
  $("resultsTable").innerHTML=html+"</table>";
};

$("clear").onclick=()=>location.reload();

document.querySelectorAll(".chart-tabs button").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".chart-tabs button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    document.querySelectorAll(".chart-wrap").forEach(w=>w.classList.remove("active"));
    document.getElementById(b.dataset.t).classList.add("active");
    Object.values(charts).forEach(c=>c && c.resize());
  };
});
</script>
<script>
  let heightTimeout;

  function sendHeight() {
    clearTimeout(heightTimeout);
    heightTimeout = setTimeout(() => {
      const height = document.documentElement.scrollHeight;
      window.parent.postMessage({ height }, "*");
    }, 50);
  }

  window.addEventListener("load", sendHeight);
  window.addEventListener("resize", sendHeight);

  const observer = new MutationObserver(sendHeight);
  observer.observe(document.body, {
    childList: true,
    subtree: true,
    attributes: true
  });
</script>
</body>
</html>
